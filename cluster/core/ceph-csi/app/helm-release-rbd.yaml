---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: ceph-csi-rbd
  namespace: kube-system
spec:
  interval: 5m
  chart:
    spec:
      chart: ceph-csi-rbd
      version: 3.16.0
      sourceRef:
        kind: HelmRepository
        name: ceph-csi-charts
        namespace: flux-system
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    # CSI Configuration for connecting to Ceph cluster
    csiConfig:
      - clusterID: "${SECRET_CEPH_CLUSTER_ID}"
        monitors:
          - "${SECRET_CEPH_MON_1}"
          - "${SECRET_CEPH_MON_2}"
          - "${SECRET_CEPH_MON_3}"
        rbd:
          mirrorDaemonCount: 1

    # StorageClass configuration
    storageClass:
      create: true
      name: ceph-rbd
      annotations:
        storageclass.kubernetes.io/is-default-class: "false"
      clusterID: "${SECRET_CEPH_CLUSTER_ID}"
      pool: "k3s"
      imageFeatures: "layering"
      fstype: ext4
      reclaimPolicy: Delete
      allowVolumeExpansion: true
      mountOptions: []
      # Secret references
      provisionerSecret: ceph-rbd-secret
      provisionerSecretNamespace: kube-system
      controllerExpandSecret: ceph-rbd-secret
      controllerExpandSecretNamespace: kube-system
      controllerPublishSecret: ceph-rbd-secret
      controllerPublishSecretNamespace: kube-system
      nodeStageSecret: ceph-rbd-secret
      nodeStageSecretNamespace: kube-system

    # Secret configuration
    secret:
      create: false
      name: ceph-rbd-secret
      userID: admin
      userKey: ""

    # CSIDriver configuration
    CSIDriver:
      fsGroupPolicy: "File"
      seLinuxMount: true
