---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: lemmy
  name: lemmy
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: lemmy
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: lemmy
    spec:
      securityContext:
        runAsUser: 991
        runAsGroup: 991
      containers:
        - name: nginx
          image: "ghcr.io/nginxinc/nginx-unprivileged:1.25-alpine"
          imagePullPolicy: IfNotPresent
          livenessProbe:
            failureThreshold: 30
            periodSeconds: 5
            successThreshold: 1
            tcpSocket:
              port: 8080
            timeoutSeconds: 1
          ports:
            - containerPort: 8080
              name: http
              protocol: TCP
          readinessProbe:
            failureThreshold: 3
            periodSeconds: 10
            successThreshold: 1
            tcpSocket:
              port: 8080
            timeoutSeconds: 1
          lifecycle:
            preStop:
              exec:
                command: ["/bin/sh", "-c", "nginx -s quit; while killall -0 nginx; do sleep 1; done"]
          startupProbe:
            failureThreshold: 30
            periodSeconds: 5
            successThreshold: 1
            tcpSocket:
              port: 8080
            timeoutSeconds: 1
          volumeMounts:
            - mountPath: /etc/nginx/conf.d/01-lemmy.conf
              readOnly: true
              name: lemmy-nginx
              subPath: 01-lemmy.conf
            - mountPath: /etc/nginx/nginx.conf
              readOnly: true
              name: lemmy-nginx
              subPath: nginx.conf
        - name: lemmy
          image: dessalines/lemmy:0.18.3
          env:
            - name: RUST_LOG
              value: warn
          ports:
            - containerPort: 8536
          readinessProbe:
            httpGet:
              path: /
              port: 8536
          livenessProbe:
            httpGet:
              path: /
              port: 8536
          volumeMounts:
            - mountPath: /config/
              name: lemmy
        - name: lemmy-ui
          image: dessalines/lemmy-ui:0.18.3
          env:
            - name: LEMMY_UI_LEMMY_INTERNAL_HOST
              value: localhost:8536
            - name: LEMMY_UI_LEMMY_EXTERNAL_HOST
              value: lemmy.${SECRET_LAB_DOMAIN}
            - name: LEMMY_UI_HTTPS
              value: "true"
          ports:
            - containerPort: 1234
          readinessProbe:
            httpGet:
              path: /
              port: 1234
          livenessProbe:
            httpGet:
              path: /
              port: 1234
        - name: pictrs
          image: asonix/pictrs:0.4.0-rc.9
          ports:
            - containerPort: 8090
          # readinessProbe:
          #   httpGet:
          #     path: /
          #     port: 8080
          # livenessProbe:
          #   httpGet:
          #     path: /
          #     port: 8080
          envFrom:
            - secretRef:
                name: lemmy-pictrs
          volumeMounts:
            - name: lemmy-pictrs
              mountPath: /mnt
      volumes:
        - name: lemmy-pictrs
          persistentVolumeClaim:
            claimName: lemmy-pictrs
        - configMap:
            name: lemmy
          name: lemmy
        - configMap:
            name: lemmy-nginx
          name: lemmy-nginx
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      terminationGracePeriodSeconds: 30
