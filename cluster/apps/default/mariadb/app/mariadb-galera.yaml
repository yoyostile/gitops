---
apiVersion: k8s.mariadb.com/v1alpha1
kind: MariaDB
metadata:
  name: mariadb-galera
  namespace: default
spec:
  rootPasswordSecretKeyRef:
    name: mariadb-galera
    key: root-password

  storage:
    size: 10Gi
    storageClassName: proxmox-data-ext4

  replicas: 3

  galera:
    enabled: true

  service:
    type: LoadBalancer
    metadata:
      annotations:
        metallb.universe.tf/loadBalancerIPs: 172.16.38.208

  primaryService:
    type: LoadBalancer
    metadata:
      annotations:
        metallb.universe.tf/loadBalancerIPs: 172.16.38.206

  secondaryService:
    type: LoadBalancer
    metadata:
      annotations:
        metallb.universe.tf/loadBalancerIPs: 172.16.38.207

  metrics:
    enabled: true

  tls:
    enabled: true
    # Enforce TLS in all connections
    required: false
    # Issue certificates with cert-manager
    serverCertIssuerRef:
      name: letsencrypt-production
      kind: ClusterIssuer
    clientCertIssuerRef:
      name: letsencrypt-production
      kind: ClusterIssuer

  # Configure Pod anti-affinity to spread replicas across nodes
  affinity:
    antiAffinityEnabled: true
    # Schedule Pods on worker nodes (not control-plane)
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: node-role.kubernetes.io/control-plane
            operator: DoesNotExist
