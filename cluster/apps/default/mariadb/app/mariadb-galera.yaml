---
apiVersion: k8s.mariadb.com/v1alpha1
kind: MariaDB
metadata:
  name: mariadb-galera
  namespace: default
spec:
  rootPasswordSecretKeyRef:
    name: mariadb-galera
    key: root-password

  bootstrapFrom:
    s3:
      bucket: k3s-lan-${SECRET_LAB_DOMAIN/./-}
      prefix: backups/mariadb
      endpoint: s3.eu-central-003.backblazeb2.com
      accessKeyIdSecretKeyRef:
        name: cluster-secrets
        key: BACKBLAZE_B2_KEY_ID
      secretAccessKeySecretKeyRef:
        name: cluster-secrets
        key: BACKBLAZE_B2_APPLICATION_KEY
      tls:
        enabled: true

  storage:
    size: 10Gi
    storageClassName: proxmox-data-ext4
    volumeClaimTemplate:
      metadata:
        labels:
          velero.io/exclude-from-backup: "true"

  replicas: 3

  galera:
    enabled: true
    config:
      reuseStorageVolume: true

  service:
    type: LoadBalancer
    metadata:
      annotations:
        metallb.universe.tf/loadBalancerIPs: 172.16.38.208
        external-dns/internal: "true"

  primaryService:
    type: LoadBalancer
    metadata:
      annotations:
        metallb.universe.tf/loadBalancerIPs: 172.16.38.206
        external-dns/internal: "true"

  secondaryService:
    type: LoadBalancer
    metadata:
      annotations:
        metallb.universe.tf/loadBalancerIPs: 172.16.38.207
        external-dns/internal: "true"

  metrics:
    enabled: true

  tls:
    enabled: false
    required: false

  affinity:
    antiAffinityEnabled: true
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
              - key: node-role.kubernetes.io/control-plane
                operator: DoesNotExist
