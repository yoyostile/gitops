---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: immich
  namespace: default
  annotations:
    configmap.reloader.stakater.com/reload: "immich-values"
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://immich-app.github.io/immich-charts
      chart: immich
      version: 0.10.3
      sourceRef:
        kind: HelmRepository
        name: immich-charts
        namespace: flux-system
      interval: 5m
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
    timeout: 10m
  values:
    defaultPodOptions:
      nodeSelector:
        topology.kubernetes.io/region: lab

    ## This chart relies on the common library chart from bjw-s
    ## You can find it at https://github.com/bjw-s/helm-charts/tree/main/charts/library/common
    ## Refer there for more detail about the supported values

    # These entries are shared between all the Immich components

    global:
      annotations:
        reloader.stakater.com/auto: "true"
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
        gpu.intel.com/i915: "1"
      limits:
        cpu: 2000m
        gpu.intel.com/i915: "1"

    controllers:
      main:
        containers:
          main:
            image:
              tag: v2.3.1
            env:
              - name: REDIS_HOSTNAME
                value: redis-headless
              - name: REDIS_PASSWORD
                value: ${IMMICH_REDIS_PASSWORD}
              - name: REDIS_DBINDEX
                value: "4"
              # - name: DB_HOSTNAME
              #   value: "{{ .Release.Name }}-postgresql"
              - name: DB_HOSTNAME
                value: "immich-postgres-rw"
              - name: DB_USERNAME
                value: "immich"
              - name: DB_DATABASE_NAME
                value: "immich"
              - name: DB_PASSWORD
                value: ${IMMICH_DB_PASSWORD}
              - name: IMMICH_MACHINE_LEARNING_URL
                value: '{{ printf "http://%s-machine-learning:3003" .Release.Name }}'
              - name: TZ
                value: "Europe/Berlin"
              - name: TRANSFORMERS_CACHE
                value: /cache
              - name: MACHINE_LEARNING_PRELOAD__CLIP
                value: ViT-B-32__openai
              - name: MACHINE_LEARNING_PRELOAD__FACIAL_RECOGNITION
                value: buffalo_l

    immich:
      metrics:
        # Enabling this will create the service monitors needed to monitor immich with the prometheus operator
        enabled: false
      persistence:
        # Main data store for all photos shared between different components.
        library:
          existingClaim: immich-nfs

      # configuration is immich-config.json converted to yaml
      # ref: https://immich.app/docs/install/config-file/
      #
      configuration: {}
        # trash:
        #   enabled: false
        #   days: 30
        # storageTemplate:
        #   enabled: true
        #   template: "{{y}}/{{y}}-{{MM}}-{{dd}}/{{filename}}"

    # Dependencies

    valkey:
      enabled: false
      architecture: standalone
      auth:
        enabled: false

    # Immich components

    server:
      enabled: true
      controllers:
        main:
          containers:
            main:
              image:
                repository: ghcr.io/immich-app/immich-server
                pullPolicy: IfNotPresent
      controller:
        replicas: 1
        strategy: RollingUpdate
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - server
                topologyKey: kubernetes.io/hostname
      persistence:
        ext-library-kjheck:
          enabled: true
          existingClaim: immich-ext-kj
          readOnly: true
      ingress:
        main:
          enabled: true
          className: "traefik-internal"
          annotations:
            hajimari.io/enable: "true"
            hajimari.io/icon: "image-album"
            traefik.ingress.kubernetes.io/router.entrypoints: "websecure"
            traefik.ingress.kubernetes.io/router.middlewares: "networking-internal-ips-only@kubernetescrd"
            external-dns/internal: "true"
          hosts:
            - host: "immich.${SECRET_LAB_DOMAIN}"
              paths:
                - path: /
                  pathType: Prefix
          tls:
            - hosts:
                - "immich.${SECRET_LAB_DOMAIN}"
              secretName: "${SECRET_LAB_DOMAIN/./-}-tls"

    machine-learning:
      enabled: true
      resources:
        requests:
          memory: 4Gi
          gpu.intel.com/i915: "1"
        limits:
          gpu.intel.com/i915: "1"
      controllers:
        main:
          containers:
            main:
              image:
                repository: ghcr.io/immich-app/immich-machine-learning
                tag: v2.5.2-openvino
                pullPolicy: IfNotPresent
              env:
                - name: TRANSFORMERS_CACHE
                  value: /cache
                - name: HF_XET_CACHE
                  value: /cache/huggingface-xet
                - name: MPLCONFIGDIR
                  value: /cache/matplotlib-config
                - name: MACHINE_LEARNING_PRELOAD__CLIP
                  value: ViT-B-32__openai
                - name: MACHINE_LEARNING_PRELOAD__FACIAL_RECOGNITION
                  value: buffalo_l
      controller:
        replicas: 1
        strategy: RollingUpdate
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - machine-learning
                topologyKey: kubernetes.io/hostname
      probes:
        liveness:
          spec:
            initialDelaySeconds: 90
        readiness:
          spec:
            initialDelaySeconds: 90
      persistence:
        ext-library-kjheck:
          enabled: true
          existingClaim: immich-ext-kj
          readOnly: true
        cache:
          enabled: true
          size: 10Gi
          # Optional: Set this to persistentVolumeClaim to avoid downloading the ML models every start.
          type: 'persistentVolumeClaim'
          accessMode: ReadWriteMany
          storageClass: 'nfs-client'
